<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cover Letter Generator</title>
    <link href="https://fonts.googleapis.com/css?family=Poppins:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <style>
        pre {
            white-space: pre-wrap;       /* Since CSS 2.1 */
            white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
            white-space: -pre-wrap;      /* Opera 4-6 */
            white-space: -o-pre-wrap;    /* Opera 7 */
            word-wrap: break-word;       /* Internet Explorer 5.5+ */
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-light bg-light">
        <a class="navbar-brand" href="{{ url_for('upload_page')}}">Upload More Files</a>
    </nav>
    <div class="container mt-5">
        <h1 class="mb-4">Cover Letter Generator</h1>
        <form id="cover-letter-form">
            <div class="form-group">
                <label for="linkedin_url">LinkedIn URL:</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="linkedin_url" name="linkedin_url">
                    <div class="input-group-append">
                        <button type="button" class="btn btn-secondary" id="scrape_linkedin">Scrape LinkedIn</button>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="company_name">Company Name:</label>
                <input type="text" class="form-control" id="company_name" name="company_name" required>
            </div>
            <div class="form-group">
                <label for="position">Position:</label>
                <input type="text" class="form-control" id="position" name="position" required>
            </div>
            <div class="form-group">
                <label for="job_descript">Job Description:</label>
                <textarea class="form-control" id="job_descript" name="job_descript" rows="5" required></textarea>
            </div>
            <div class="form-group text-center">
                <button type="submit" class="btn btn-primary mr-2">Generate Cover Letter</button>
                <a href="/download" id="download-button" class="btn btn-success mt-2" style="display: none;">Download Cover Letter</a>
            </div>
        </form>
        <div class="mt-5">
            <h2>Cover Letter:</h2>
            <div class="spinner-border text-primary" role="status" style="display: none;">
                <span class="sr-only">Loading...</span>
              </div>
              <button id="copy-btn" class="btn btn-outline-secondary">Copy</button>
            <pre id="cover_letter" class="border p-3 mt-2"></pre>
        </div>
    </div>
    <!-- Your existing JavaScript code goes here -->
    <script>
        $('#scrape_linkedin').click(function() {
            var linkedin_url = $('#linkedin_url').val();
            $.post('/scrape_linkedin', {linkedin_url: linkedin_url}, function(data) {
                $('#company_name').val(data.company_name);
                $('#position').val(data.job_title);
                $('#job_descript').val(data.job_description);
            });
        });

        $('#cover-letter-form').submit(function(e) {
            e.preventDefault();
            $('.spinner-border').show(); // Show the loading animation
            // Clear the input fields
            $('#cover_letter').text('');
    
            var source = new EventSource("/generate_cover_letter");
            source.onmessage = function(event) {
                var token = event.data;
                if (token === 'END') {
                    $('.spinner-border').show();
                    console.log("WE'RE END BRO");
                    source.close();
            
                    // Fetch the final text
                    $.get('/get_final_cover_letter', function(data) {
                            setTimeout(function() {
                                // Replace the content of the chatbox with the final text
                                $('#cover_letter').text(data.cover_letter);
                                $('.spinner-border').hide(); // Hide the loader
                                $('#cover_letter').show(); // Show the chatbox
                                $('#download-button').show(); // Show the download button
                            }, 1000); // Wait for 1 second
                        });
                } else {
                    var chatbox = document.getElementById('cover_letter');
                    chatbox.textContent += token;
                }
            };

            $.post('/generate_cover_letter', $(this).serialize(), function(data) {
                // might not need this anymore as data is streamed
                // $('#cover_letter').text(data.cover_letter); 
                $('.spinner-border').hide(); // Hide the loading animation
    
                // Store the input and output in the log
                const index = $('#previous-requests option').length;
                $('#previous-requests').append(`<option value="${index}">${companyName} - ${position}</option>`);
    
                // Store the input and output as data attributes for the option
                const option = $('#previous-requests option[value="' + index + '"]');
                option.data('companyName', companyName);
                option.data('position', position);
                option.data('jobDescription', jobDescription);
                option.data('coverLetter', coverLetter);
    
                // Update the input boxes when a previous request is selected
                $('#previous-requests').change(function() {
                    const selectedOption = $('#previous-requests option:selected');
                    $('#company_name').val(selectedOption.data('companyName'));
                    $('#position').val(selectedOption.data('position'));
                    $('#job_descript').val(selectedOption.data('jobDescription'));
                    $('#cover_letter').text(selectedOption.data('coverLetter'));
                });
            });
        });
    </script>
    
    
    <script>
        document.querySelector("#copy-btn").addEventListener("click", function() {
            // Create a new textarea element and give it id='t'
            var copyText = document.createElement('textarea');
            copyText.id = 't';
            // Optional step to make less noise on the page, if any!
            copyText.style.height = "0";
            // Now append it to your page somewhere, I chose <body>
            document.body.appendChild(copyText);
            // Give our textarea a value of whatever inside the div of id='cover_letter'
            copyText.value = document.getElementById('cover_letter').innerText;
            // Now copy whatever inside the textarea to clipboard
            var copy = document.getElementById('t');
            copy.select();
            document.execCommand('copy');
            // Remove the textarea
            document.body.removeChild(copyText);

            // Add a checkmark next to the button
            var checkmarkSpan = document.createElement('span');
            checkmarkSpan.innerHTML = '✔️';
            checkmarkSpan.className= 'inline-component'
            document.getElementById("copy-btn").className = 'inline-component';  // Apply the new class to the button
            document.getElementById("copy-btn").after(checkmarkSpan);
            
            // Remove the checkmark after a short delay
            setTimeout(function() {
                document.getElementById("copy-btn").nextSibling.remove();
            }, 2000);
        });
    </script>

</body>
</html>
